<!DOCTYPE html>
<html>
<head>
  <title>Google Maps Web App</title>
  <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>


  <script>
    let map;
    let debounceTimer;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: -34.397, lng: 150.644 },
    zoom: 8,
  });

google.maps.event.addListener(map, "zoom_changed", () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    if (map.getZoom() >= 15) {
      populateTableWithVisibleStreets();
    } else {
      clearTable();
    }
  }, 1500); // Adjust the debounce time in milliseconds as needed
});

google.maps.event.addListener(map, "bounds_changed", () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    if (map.getZoom() >= 15) {
      populateTableWithVisibleStreets();
    } else {
      clearTable();
    }
  }, 1500); // Adjust the debounce time in milliseconds as needed
});

}

function populateTableWithVisibleStreets() {
  const bounds = map.getBounds();
  const northEast = bounds.getNorthEast();
  const southWest = bounds.getSouthWest();

  const overpassQuery = `
    [out:json][timeout:25];
    (
      way[highway][name](${southWest.lat()},${southWest.lng()},${northEast.lat()},${northEast.lng()});
    );
    out body;
  `;

  const overpassApiUrl = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery.trim())}`;

  fetch(overpassApiUrl)
    .then((response) => response.json())
    .then((data) => {
      const streetNames = data.elements
        .filter((element) => element.tags && element.tags.name)
        .map((element) => element.tags.name);
      const uniqueStreetNames = [...new Set(streetNames)];
      populateTable(uniqueStreetNames, '{{ google_maps_api_key }}'); // Pass the API key as a string
    })
    .catch((error) => {
      console.error('Error fetching street names:', error);
    });

}


function populateTable(streetNames, apiKey) {
  const table = document.getElementById("info-table");

  // Clear the table before populating it
  while (table.rows.length > 1) {
    table.deleteRow(1);
  }

  streetNames.forEach((streetName) => {
    const row = table.insertRow();
    const cell1 = row.insertCell();
    cell1.textContent = streetName;

    // Pass the entire `row` instead of `cell1` as the first argument
    populateRowWithStreetViewImageDate(row, streetName, apiKey);
  });
}


async function populateRowWithStreetViewImageDate(row, streetName) {
  try {
    const streetLatLng = await geocodeStreet(streetName);
    const latLng = new google.maps.LatLng(streetLatLng.lat, streetLatLng.lng);

    const streetViewService = new google.maps.StreetViewService();
    streetViewService.getPanoramaByLocation(latLng, 50, (data, status) => {
      if (status === google.maps.StreetViewStatus.OK) {
        const imageDate = data.imageDate;
        const cell2 = row.insertCell(1);
        cell2.textContent = imageDate;
      } else {
        console.error(`Error fetching Street View image date for ${streetName}: ${status}`);
      }
    });
  } catch (error) {
    console.error(`Error fetching Street View image date for ${streetName}:`, error);
  }
}


async function geocodeStreet(streetName, apiKey) {
  const geocoder = new google.maps.Geocoder();
  const request = {
    address: streetName,
    bounds: map.getBounds(),
  };

  return new Promise((resolve, reject) => {
    geocoder.geocode(request, (results, status) => {
      if (status === "OK") {
        const latLng = results[0].geometry.location;
        resolve({ lat: latLng.lat(), lng: latLng.lng() });
      } else {
        reject(new Error(`Geocoding failed for ${streetName}: ${status}`));
      }
    });
  });
}


    
function clearTable() {
  const table = document.getElementById("info-table");

  if (table) {
    // Clear the table
    while (table.rows.length > 1) {
      table.deleteRow(1);
    }

    // Add a message when zoom level is below 15
    const row = table.insertRow();
    const cell = row.insertCell();
    cell.textContent = "Zoom in to see Streetview data";
    cell.colSpan = 2; // Span the message across both columns
    cell.style.textAlign = "center";
  }
}

async function fetchStreets(center, radius) {
  const overpassApiUrl = `https://overpass-api.de/api/interpreter?data=[out:json][timeout:25];(way[highway](around:${radius},${center.lat()},${center.lng()}));(._;>;);out body;`;
  const response = await fetch(overpassApiUrl);
  const data = await response.json();
  const streets = data.elements.filter(element => element.type === "way");
  const nodes = data.elements.filter(element => element.type === "node");

  const midPoints = streets.map(street => {
    const streetNodes = street.nodes.map(nodeId => nodes.find(node => node.id === nodeId));
    const midIndex = Math.floor((streetNodes.length - 1) / 2);
    const midPoint = {
      lat: streetNodes[midIndex].lat,
      lon: streetNodes[midIndex].lon
    };
    return midPoint;
  });

  console.log(midPoints);
}
    

  </script>
  <style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }

  #map {
    height: 100%;
    width: 70%;
    float: left;
    box-sizing: border-box; /* Add this line */
  }

  #info-table-container {
    height: 100%;
    width: 30%;
    float: right;
    overflow-y: auto;
    background-color: #f8f9fa;
    padding: 20px;
    box-sizing: border-box; /* Add this line */
  }

  table {
    border-collapse: collapse;
    width: 100%;
  }

  th, td {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
  }

  th {
    background-color: #f2f2f2;
  }
</style>

</head>
<body onload="initMap()">
  <div id="map"></div>
  <div id="info-table-container">
     <table id="info-table">
    <tr>
      <th>Name</th>
      <th>Image Date</th>
    </tr>
    <!-- The table rows will be added dynamically -->
  </table>

  </div>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Google Maps Web App</title>
  <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>


  <script>
    let map;
    let debounceTimer;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: -34.397, lng: 150.644 },
    zoom: 8,
  });

google.maps.event.addListener(map, "zoom_changed", () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    if (map.getZoom() >= 15) {
      populateTableWithVisibleStreets();
    } else {
      clearTable();
    }
  }, 1000); // Adjust the debounce time in milliseconds as needed
});

google.maps.event.addListener(map, "bounds_changed", () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    if (map.getZoom() >= 15) {
      populateTableWithVisibleStreets();
    } else {
      clearTable();
    }
  }, 1000); // Adjust the debounce time in milliseconds as needed
});

}

function populateTableWithVisibleStreets() {
  const bounds = map.getBounds();
  const northEast = bounds.getNorthEast();
  const southWest = bounds.getSouthWest();

  const overpassQuery = `
    [out:json][timeout:25];
    (
      way[highway][name](${southWest.lat()},${southWest.lng()},${northEast.lat()},${northEast.lng()});
    );
    out body;
  `;

  const overpassApiUrl = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery.trim())}`;

  fetch(overpassApiUrl)
    .then((response) => response.json())
    .then((data) => {
      const streets = data.elements
        .filter((element) => element.tags && element.tags.name)
        .map((element) => ({
          name: element.tags.name,
          nodes: element.nodes, // Store the street's nodes
          id: element.id, // Store the street's ID
        }));

      const uniqueStreetNames = [...new Set(streets.map((street) => street.name))];
      populateTable(uniqueStreetNames, streets, data);
    })
}


function populateTable(streetNames, streets, data) {
  const table = document.getElementById("info-table");

  // Clear the table before populating it
  while (table.rows.length > 1) {
    table.deleteRow(1);
  }

  streetNames.forEach((streetName) => {
    const street = streets.find((s) => s.name === streetName);
    const midpoint = calculateStreetMidpoint(street, data);

    const row = table.insertRow();
    const cell1 = row.insertCell();
    cell1.textContent = streetName;

    const cell2 = row.insertCell();
    cell2.textContent = `${midpoint.lat.toFixed(6)}, ${midpoint.lng.toFixed(6)}`; // Display the midpoint coordinates
  });
}


function clearTable() {
  const table = document.getElementById("info-table");

  if (table) {
    // Clear the table
    while (table.rows.length > 1) {
      table.deleteRow(1);
    }

    // Add a message when zoom level is below 15
    const row = table.insertRow();
    const cell = row.insertCell();
    cell.textContent = "Zoom in to see Streetview data";
    cell.colSpan = 2; // Span the message across both columns
    cell.style.textAlign = "center";
  }
}

function calculateStreetMidpoint(street, data) {
  const nodes = street.nodes;
  const totalNodes = nodes.length;

  if (totalNodes === 0) {
    return { lat: 0, lng: 0 };
  }

  if (totalNodes === 1) {
    const node = data.elements.find((element) => element.type === "node" && element.id === nodes[0]);
    if (!node) {
      console.error(`Node not found for ID ${nodes[0]}`);
      return { lat: 0, lng: 0 };
    }
    return { lat: node.lat, lng: node.lon };
  }

  const middleNodeIndex = Math.floor(totalNodes / 2) - 1;
  const node1 = data.elements.find((element) => element.type === "node" && element.id === nodes[middleNodeIndex]);
  const node2 = data.elements.find((element) => element.type === "node" && element.id === nodes[middleNodeIndex + 1]);

  if (!node1 || !node2) {
    console.error(`Nodes not found for IDs ${nodes[middleNodeIndex]}, ${nodes[middleNodeIndex + 1]}`);
    return { lat: 0, lng: 0 };
  }

  const midpoint = {
    lat: (node1.lat + node2.lat) / 2,
    lng: (node1.lon + node2.lon) / 2,
  };

  return midpoint;
}




  </script>
  <style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }

  #map {
    height: 100%;
    width: 70%;
    float: left;
    box-sizing: border-box; /* Add this line */
  }

  #info-table-container {
    height: 100%;
    width: 30%;
    float: right;
    overflow-y: auto;
    background-color: #f8f9fa;
    padding: 20px;
    box-sizing: border-box; /* Add this line */
  }

  table {
    border-collapse: collapse;
    width: 100%;
  }

  th, td {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
  }

  th {
    background-color: #f2f2f2;
  }
</style>

</head>
<body onload="initMap()">
  <div id="map"></div>
  <div id="info-table-container">
     <table id="info-table">
    <tr>
      <th>Name</th>
    </tr>
    <!-- The table rows will be added dynamically -->
  </table>

  </div>
</body>
</html>
